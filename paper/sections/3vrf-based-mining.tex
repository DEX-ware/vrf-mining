\section{VRF-based mining}
\label{sec:construction}

% intuitive
Instead of using a hash function, VRF-based mining uses a VRF to produce outputs that satisfy the difficulty requirement.
VRF takes both an input and a secret key to produce an output.
The owner of this secret key can produce a proof proving the ownership of his output.
Thus, to outsource the mining process, the pool operator has to reveal his secret key to miners.
However, with the secret key, any miner in the mining pool can steal all mining rewards.

\begin{algorithm}[]
\caption{$\mathsf{Work}(sk, t, T)$.}\label{algo:work}
\SetAlgoLined\DontPrintSemicolon
\KwIn{The secret key $sk$, the block template $t$, and the blockchain difficulty $T$}
\KwOut{The block $blk$, the VRF output $out$, and the VRF proof $\pi$}
  Initialise $n$, $out$, $blk$ \Comment*[r]{Initialise variables}
  \While (\Comment*[f]{Refresh the nonce}) {$n += 1$}{
    $blk \gets \mathsf{ConstructBlock}(t, n)$ \Comment*[r]{Assemble block}
    $out \gets \mathsf{VRFHash}(sk, blk)$ \Comment*[r]{Produce VRF output}
    \If (\Comment*[f]{If meeting difficulty}) {$out < T$}{
      break \Comment*[r]{Mining successful}
    }
  }
  $\pi \gets \mathsf{VRFProve}(sk, blk)$ \Comment*[r]{Produce the proof}
  \Return{$blk$, $out$, $\pi$} \Comment*[r]{Return block, output and proof}
\end{algorithm}



\begin{algorithm}[h]
\caption{$\mathsf{Verify}(blk, out, \pi, T)$}\label{algo:verify}
\SetAlgoLined\DontPrintSemicolon
$pk \gets blk . txs[0] . scriptPubKey$ \Comment*[r]{Find miner's pk}
$\mathsf{require}(out < T)$ \Comment*[r]{Check if satisfying diff}
\tcc{Here $\mathsf{VRFVerify}(\cdot)$ ensures:\\
1. $out$ is generated by the owner of $sk$\\
2. $out$ is a valid output of $\mathsf{VRFHash}(sk, blk)$}
$\mathsf{require}(\mathsf{VRFVerify}(pk, blk, out, \pi))$ \;
$\dots$ \Comment*[l]{Verify other fields}
$\dots$ \Comment*[l]{Verify transactions}
\end{algorithm}

Cryptocurrency mining consists of two components, namely mining blocks and verifying blocks.
We call the process of mining a block $\mathsf{Work}(\cdot)$, and the process of verifying a block $\mathsf{Verify}(\cdot)$.
Algorithm~\ref{algo:work} and \ref{algo:verify} describe $\mathsf{Work}(\cdot)$ and $\mathsf{Verify}(\cdot)$ of VRF-based mining, respectively.

\textbf{Work.}
Miners run $\mathsf{Work}(\cdot)$ to mine new blocks.
More specifically, a miner - with his private key $sk$ the block template (a complete block without nonce) $t$ - keeps searching for a nonce $n$ that can make the VRF output $out$ of the block $blk$ to meet the blockchain difficulty $T$.
Once finding a valid $n$, the miner produces the proof $\pi$ and $out$, and appends $blk$ (with $n$), $out$ and $\pi$ to the blockchain.

\textbf{Verify.}
Upon incoming blocks, miners run $\mathsf{Verify}(\cdot)$ to verify their validity.
While other verifications are the same as in hash-based mining, $\mathsf{Verify}(\cdot)$ in VRF-based mining should additionally run $\mathsf{VRFVerify}(\cdot)$ to verify 1) whether $out$ is produced by the owner of $sk$, and 2) whether $out$ is a valid output of $\mathsf{VRFHash}(sk, blk)$.

\textbf{Block structure.}
In a blockchain deploying VRF-based mining, each block should additionally attach $out$ and $\pi$.
Other miners without knowing $sk$ cannot produce $out$, but can use $\pi$ to verify $out$ is generated by someone knowing $sk$.
The proof $\pi$ proves that, 1) the block is produced by someone knowing $sk$, and 2) the digest of this block is $out$.